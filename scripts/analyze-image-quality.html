<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì´ë¯¸ì§€ í’ˆì§ˆ ë¶„ì„</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .image-preview {
      max-width: 500px;
      margin: 20px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    .score {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }
    .good { color: #22c55e; }
    .moderate { color: #eab308; }
    .poor { color: #ef4444; }
    .metric {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-left: 4px solid #3b82f6;
    }
    .issue {
      color: #ef4444;
      margin: 5px 0;
    }
    .recommendation {
      color: #3b82f6;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ì´ë¯¸ì§€ í’ˆì§ˆ ë¶„ì„ ë„êµ¬</h1>
    <input type="file" id="fileInput" accept="image/*">
    <div id="preview"></div>
    <div id="results"></div>
  </div>

  <script type="module">
    // ì´ë¯¸ì§€ í’ˆì§ˆ ê²€ì‚¬ ë¡œì§ (ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰)
    async function checkImageQuality(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = (e) => {
          const img = new Image()
          img.onload = () => {
            const canvas = document.createElement('canvas')
            const maxSize = 512
            let width = img.width
            let height = img.height
            
            if (width > maxSize || height > maxSize) {
              const ratio = Math.min(maxSize / width, maxSize / height)
              width = Math.floor(width * ratio)
              height = Math.floor(height * ratio)
            }
            
            canvas.width = width
            canvas.height = height

            const ctx = canvas.getContext('2d')
            if (!ctx) {
              reject(new Error('Canvas context not available'))
              return
            }

            ctx.drawImage(img, 0, 0, width, height)

            const laplacianKernel = [0, -1, 0, -1, 4, -1, 0, -1, 0]
            const imageData = ctx.getImageData(0, 0, width, height)
            const data = imageData.data
            
            let laplacianSum = 0
            let pixelCount = 0

            for (let y = 1; y < height - 1; y++) {
              for (let x = 1; x < width - 1; x++) {
                let laplacian = 0

                for (let ky = -1; ky <= 1; ky++) {
                  for (let kx = -1; kx <= 1; kx++) {
                    const idx = ((y + ky) * width + (x + kx)) * 4
                    const kernelIdx = (ky + 1) * 3 + (kx + 1)
                    const weight = laplacianKernel[kernelIdx]
                    
                    const r = data[idx]
                    const g = data[idx + 1]
                    const b = data[idx + 2]
                    const gray = (r + g + b) / 3
                    
                    laplacian += gray * weight
                  }
                }

                laplacianSum += Math.abs(laplacian)
                pixelCount++
              }
            }

            if (pixelCount === 0) {
              resolve(0)
              return
            }

            const meanAbsoluteLaplacian = laplacianSum / pixelCount
            const normalizedScore = Math.min(1.0, meanAbsoluteLaplacian / 50)

            resolve(normalizedScore)
          }
          img.onerror = () => reject(new Error('Failed to load image'))
          img.src = e.target?.result
        }
        reader.onerror = () => reject(new Error('Failed to read file'))
        reader.readAsDataURL(file)
      })
    }

    async function analyzeBrightness(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = (e) => {
          const img = new Image()
          img.onload = () => {
            const canvas = document.createElement('canvas')
            canvas.width = img.width
            canvas.height = img.height

            const ctx = canvas.getContext('2d')
            if (!ctx) {
              reject(new Error('Canvas context not available'))
              return
            }

            ctx.drawImage(img, 0, 0)
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
            const data = imageData.data

            let totalBrightness = 0
            let pixelCount = 0

            for (let i = 0; i < data.length; i += 4) {
              const r = data[i]
              const g = data[i + 1]
              const b = data[i + 2]
              const gray = (r + g + b) / 3
              
              totalBrightness += gray
              pixelCount++
            }

            if (pixelCount === 0) {
              resolve(50)
              return
            }

            const averageBrightness = totalBrightness / pixelCount

            let score
            if (averageBrightness < 80) {
              score = (averageBrightness / 80) * 40
            } else if (averageBrightness <= 150) {
              score = 40 + ((averageBrightness - 80) / 70) * 20
            } else if (averageBrightness <= 200) {
              score = 60 + ((averageBrightness - 150) / 50) * 20
            } else {
              score = 80 + ((averageBrightness - 200) / 55) * 20
              if (score > 100) score = 100
            }

            resolve(Math.round(score))
          }
          img.onerror = () => reject(new Error('Failed to load image'))
          img.src = e.target?.result
        }
        reader.onerror = () => reject(new Error('Failed to read file'))
        reader.readAsDataURL(file)
      })
    }

    async function analyzeFaceAngle(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader()
        reader.onload = (e) => {
          const img = new Image()
          img.onload = () => {
            if (img.width === 0 || img.height === 0) {
              resolve(75)
              return
            }
            
            const aspectRatio = img.width / img.height
            
            if (!isFinite(aspectRatio)) {
              resolve(75)
              return
            }
            const ratioScore = aspectRatio >= 0.7 && aspectRatio <= 1.3 ? 80 : 60

            resolve(ratioScore)
          }
          img.onerror = () => reject(new Error('Failed to load image'))
          img.src = e.target?.result
        }
        reader.onerror = () => reject(new Error('Failed to read file'))
        reader.readAsDataURL(file)
      })
    }

    async function analyzeImage(file) {
      const resultsDiv = document.getElementById('results')
      const previewDiv = document.getElementById('preview')
      
      resultsDiv.innerHTML = '<p>ë¶„ì„ ì¤‘...</p>'
      
      // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
      const img = document.createElement('img')
      img.src = URL.createObjectURL(file)
      img.className = 'image-preview'
      previewDiv.innerHTML = ''
      previewDiv.appendChild(img)

      try {
        const sharpnessScore = await checkImageQuality(file)
        const sharpness = Math.round(sharpnessScore * 100)
        
        const brightness = await analyzeBrightness(file)
        const angle = await analyzeFaceAngle(file)

        const weights = {
          sharpness: 0.4,
          brightness: 0.35,
          angle: 0.25,
        }

        const overallScore = Math.round(
          sharpness * weights.sharpness +
          brightness * weights.brightness +
          angle * weights.angle
        )

        const issues = []
        const recommendations = []

        if (sharpness < 50) {
          issues.push('ì´ë¯¸ì§€ê°€ íë¦¿í•©ë‹ˆë‹¤')
          recommendations.push('ë” ì„ ëª…í•œ ì‚¬ì§„ì„ ì´¬ì˜í•´ì£¼ì„¸ìš”')
        } else if (sharpness < 70) {
          recommendations.push('ì´ˆì ì„ ë” ì •í™•íˆ ë§ì¶°ì£¼ì„¸ìš”')
        }

        if (brightness < 40) {
          issues.push('ì¡°ëª…ì´ ë„ˆë¬´ ì–´ë‘¡ìŠµë‹ˆë‹¤')
          recommendations.push('ë°ì€ ê³³ì—ì„œ ì´¬ì˜í•´ì£¼ì„¸ìš”')
        } else if (brightness < 60) {
          recommendations.push('ì¡°ëª…ì„ ë” ë°ê²Œ í•´ì£¼ì„¸ìš”')
        } else if (brightness > 90) {
          issues.push('ì¡°ëª…ì´ ë„ˆë¬´ ë°ìŠµë‹ˆë‹¤')
          recommendations.push('ê³¼ë„í•œ ì¡°ëª…ì„ í”¼í•´ì£¼ì„¸ìš”')
        }

        if (angle < 60) {
          issues.push('ì–¼êµ´ì´ ì •ë©´ì´ ì•„ë‹™ë‹ˆë‹¤')
          recommendations.push('ì •ë©´ì„ í–¥í•´ ì´¬ì˜í•´ì£¼ì„¸ìš”')
        } else if (angle < 80) {
          recommendations.push('ì–¼êµ´ì„ ë” ì •ë©´ìœ¼ë¡œ í–¥í•´ì£¼ì„¸ìš”')
        }

        const scoreClass = overallScore >= 80 ? 'good' : overallScore >= 60 ? 'moderate' : 'poor'
        
        resultsDiv.innerHTML = `
          <div class="result">
            <h2>ë¶„ì„ ê²°ê³¼</h2>
            <div class="score ${scoreClass}">
              ì¢…í•© ì ìˆ˜: ${overallScore}ì 
            </div>
            
            <div class="metric">
              <strong>ì„ ëª…ë„ (Sharpness):</strong> ${sharpness}ì 
              <div>Mean Absolute Laplacian: ${(sharpnessScore * 50).toFixed(2)}</div>
            </div>
            
            <div class="metric">
              <strong>ì¡°ëª… (Brightness):</strong> ${brightness}ì 
            </div>
            
            <div class="metric">
              <strong>ê°ë„ (Angle):</strong> ${angle}ì 
            </div>

            ${issues.length > 0 ? `
              <h3>ë°œê²¬ëœ ë¬¸ì œì </h3>
              ${issues.map(issue => `<div class="issue">âš ï¸ ${issue}</div>`).join('')}
            ` : ''}

            ${recommendations.length > 0 ? `
              <h3>ê¶Œì¥ì‚¬í•­</h3>
              ${recommendations.map(rec => `<div class="recommendation">ğŸ’¡ ${rec}</div>`).join('')}
            ` : ''}

            <h3>ì´ë¯¸ì§€ ì •ë³´</h3>
            <div class="metric">
              <div>íŒŒì¼ëª…: ${file.name}</div>
              <div>íŒŒì¼ í¬ê¸°: ${(file.size / 1024).toFixed(2)} KB</div>
              <div>ì´ë¯¸ì§€ í¬ê¸°: ${img.naturalWidth}x${img.naturalHeight}px</div>
            </div>
          </div>
        `
      } catch (error) {
        resultsDiv.innerHTML = `<div class="result"><p style="color: red;">ì˜¤ë¥˜: ${error.message}</p></div>`
      }
    }

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0]
      if (file) {
        analyzeImage(file)
      }
    })
  </script>
</body>
</html>

